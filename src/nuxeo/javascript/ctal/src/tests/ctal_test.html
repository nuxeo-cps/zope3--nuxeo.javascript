<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="en" lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cpsskins=http://namespaces.zope.org/cpsskins">
<head>
  <title>CTAL Unit test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <script src="prototype.js" type="text/javascript"></script>
  <script src="unittest.js" type="text/javascript"></script>
  <link rel="stylesheet" href="test.css" type="text/css" />

  <script src="../ctal.js" type="text/javascript"></script>
</head>
<body>

<h1>CTAL unit tests</h1>

<p>
  Tests for the CTAL interpreter.
</p>

<!-- Log output -->
<div id="testlog"> </div>

<!-- Testing area -->

<!-- ctal:content -->
<div id="e0"><span ctal:content="a">...</span></div>
<div id="e1"><span ctal:content="c/d">...</span></div>
<div id="e2"><span ctal:content="string:a">...</span></div>
<div id="e3"><span ctal:content="k/l/m">...</span></div>
<div id="e3b"><span ctal:content="not:cfalse">...</span></div>
<div id="e3c"><span ctal:content="not:ctrue">...</span></div>

<!-- ctal:condition / ctal:content -->
<div id="e4"><span ctal:condition="ctrue"
                   ctal:content="string:b">...</span></div>

<div id="e4b"><span ctal:content="string:b"
                   ctal:condition="ctrue">...</span></div>

<div id="e5"><span ctal:condition="cfalse"
                   ctal:content="string:c">...</span></div>

<div id="e5b"><span ctal:content="string:C"
                    ctal:condition="cfalse">...</span></div>

<!-- ctal:content / ctal:attributes -->
<div id="e6"><span ctal:content="string:d"
                   ctal:attributes="class string:e">...</span></div>

<div id="e6b"><span ctal:attributes="class string:e"
                    ctal:content="string:d">...</span></div>

<!-- ctal:condition / ctal:content / ctal:attributes -->
<div id="e7"><span ctal:condition="ctrue"
                   ctal:content="string:f"
                   ctal:attributes="class string:g">...</span></div>

<div id="e7b"><span ctal:content="string:f"
                    ctal:condition="ctrue"
                    ctal:attributes="class string:g">...</span></div>

<div id="e7c"><span ctal:attributes="class string:g"
                    ctal:content="string:f"
                    ctal:condition="ctrue">...</span></div>

<div id="e7d"><span ctal:content="string:f"
                    ctal:attributes="class string:g"
                    ctal:condition="ctrue">...</span></div>

<div id="e7e"><span ctal:condition="ctrue"
                    ctal:attributes="class string:g"
                    ctal:content="string:f">...</span></div>

<div id="e8"><span ctal:condition="cfalse"
                   ctal:content="string:h"
                   ctal:attributes="class string:i">...</span></div>

<div id="e8b"><span ctal:condition="cfalse"
                    ctal:attributes="class string:i"
                    ctal:content="string:h">...</span></div>

<div id="e8c"><span ctal:content="string:h"
                    ctal:condition="cfalse"
                    ctal:attributes="class string:i">...</span></div>

<div id="e8c"><span ctal:content="string:h"
                    ctal:attributes="class string:i"
                    ctal:condition="cfalse">...</span></div>

<div id="e8d"><span ctal:attributes="class string:i"
                    ctal:content="string:h"
                    ctal:condition="cfalse">...</span></div>

<div id="e8e"><span ctal:attributes="class string:i"
                    ctal:condition="cfalse"
                    ctal:content="string:h">...</span></div>

<div id="e8f"><span ctal:attributes="class string:i"
                    ctal:condition="cfalse"
                    ctal:content="string:h">...</span></div>

<!-- ctal:omit-tag / ctal:content -->
<div id="e9"><span ctal:omit-tag="ctrue"
                   ctal:condition="ctrue"
                   ctal:content="string:j">...</span></div>

<div id="e9b"><span ctal:omit-tag="ctrue"
                   ctal:content="string:j"
                   ctal:condition="ctrue">...</span></div>

<div id="e9c"><span ctal:condition="ctrue"
                    ctal:omit-tag="ctrue"
                    ctal:content="string:j">...</span></div>

<div id="e9d"><span ctal:condition="ctrue"
                    ctal:content="string:j"
                    ctal:omit-tag="ctrue">...</span></div>

<div id="e9e"><span ctal:content="string:j"
                    ctal:condition="ctrue"
                    ctal:omit-tag="ctrue">...</span></div>

<div id="e9f"><span ctal:content="string:j"
                    ctal:omit-tag="ctrue"
                    ctal:condition="ctrue">...</span></div>

<div id="e10"><span ctal:content="string:k"
                    ctal:omit-tag="ctrue"
                    ctal:condition="cfalse">...</span></div>

<div id="e10b"><span ctal:content="string:k"
                     ctal:condition="cfalse"
                     ctal:omit-tag="ctrue">...</span></div>

<div id="e10c"><span ctal:omit-tag="ctrue"
                     ctal:condition="cfalse"
                     ctal:content="string:k">...</span></div>

<div id="e10d"><span ctal:omit-tag="ctrue"
                     ctal:content="string:k"
                     ctal:condition="cfalse">...</span></div>

<div id="e10e"><span ctal:condition="cfalse"
                     ctal:omit-tag="ctrue"
                     ctal:content="string:k">...</span></div>

<div id="e10f"><span ctal:condition="cfalse"
                     ctal:content="string:k"
                     ctal:omit-tag="ctrue">...</span></div>

<div id="e11"><span ctal:omit-tag="cfalse"
                    ctal:condition="ctrue"
                    ctal:content="string:l">...</span></div>

<div id="e12"><span ctal:omit-tag="cfalse"
                    ctal:condition="cfalse"
                    ctal:content="string:m">...</span></div>

<!-- ctal:attributes -->
<div id="e13"><a ctal:attributes="alt string:o">...</a></div>
<div id="e14"><a ctal:attributes="href string:http://p/; alt string:o;">...</a></div>

<!-- ctal:attributes / tal:content -->
<div id="e15"><a ctal:attributes="href string:http://r/; alt string:q;"
                 ctal:content="string:s">...</a></div>

<div id="e15b"><a ctal:content="string:s"
            ctal:attributes="href string:http://r/; alt string:q;">...</a></div>

<!-- ctal:replace -->
<div id="e16"><span ctal:replace="string:T">...</span></div>

<!-- ctal:condition / ctal:replace -->
<div id="e17"><span ctal:condition="ctrue"
                    ctal:replace="string:u">...</span></div>
<div id="e17b"><span ctal:replace="string:u"
                     ctal:condition="ctrue">...</span></div>

<div id="e18"><span ctal:condition="cfalse"
                    ctal:replace="string:v">...</span></div>
<div id="e18b"><span ctal:replace="string:v"
                     ctal:condition="cfalse">...</span></div>

<!-- ctal:repeat / ctal:content -->
<div id="e19"><div
     ctal:repeat="item f"><p ctal:content="item">...</p></div></div>

<div id="e20"><div
     ctal:repeat="item f"
     ctal:content="item">...</div></div>

<div id="e20b"><div
     ctal:content="item"
     ctal:repeat="item f">...</div></div>

<!-- ctal:repeat / ctal:attributes / ctal:content -->
<div id="e21"><div
     ctal:repeat="item f"
     ctal:attributes="alt item">...</div></div>

<div id="e21b"><div
     ctal:attributes="alt item"
     ctal:repeat="item f">...</div></div>

<div id="e22"><div
     ctal:repeat="item f"
     ctal:content="item">...</div></div>

<div id="e22b"><div
     ctal:content="item"
     ctal:repeat="item f">...</div></div>

<div id="e23"><div
     ctal:repeat="item f"
     ctal:attributes="alt item"
     ctal:content="item">...</div></div>

<div id="e24"><div
     ctal:condition="ctrue"
     ctal:repeat="item f">...</div></div>

<div id="e24b"><div
     ctal:repeat="item f"
     ctal:condition="ctrue">...</div></div>

<div id="e25"><div
     ctal:condition="cfalse"
     ctal:repeat="item f">...</div></div>

<div id="e25b"><div
     ctal:repeat="item f"
     ctal:condition="cfalse">...</div></div>

<div id="e26"><div
     ctal:condition="ctrue"
     ctal:repeat="item f"
     ctal:attributes="alt item">...</div></div>

<div id="e27"><div
     ctal:condition="cfalse"
     ctal:repeat="item f"
     ctal:attributes="alt item">...</div></div>

<div id="e28"><div
     ctal:condition="ctrue"
     ctal:repeat="item f"
     ctal:content="item">...</div></div>

<div id="e29"><div
     ctal:condition="cfalse"
     ctal:repeat="item f"
     ctal:content="item">...</div></div>

<!-- ctal:attributes -->
<div id="e30"><span
     ctal:attributes="color string:red">...</span></div>

<div id="e30b"><span
     ctal:attributes="color string:red;">...</span></div>

<div id="e30c"><span
     ctal:attributes="color string:red ;">...</span></div>

<div id="e30d"><span
     ctal:attributes="color string:red; class string: large">...</span></div>

<div id="e30e"><span
     ctal:attributes="color string:red; class string: large;">...</span></div>

<div id="e30f"><span
     ctal:attributes=" color string:red; class string: large; ">...</span></div>

<div id="e30g"><span
     ctal:attributes="color string: red; class string: large; ">...</span></div>

<!-- javascript: -->
<div id="e31"><span ctal:content="javascript:1">...</span></div>

<div id="e31b"><span ctal:content="javascript:1+1">...</span></div>

<div id="e31c"><span
                ctal:content="javascript:k['l']['m']">...</span></div>

<!-- edge cases -->

<!-- item/id should never be accessed -->
<div id="e32"><p ctal:repeat="item javascript:[]"><span
                 ctal:content="item/id">...</span></div>

<!-- the repeat loop 'a' variable should not override the global variable
     'a' in the data structure -->
<div id="e33"><p ctal:repeat="a javascript:[1, 2]"><span
                 ctal:content="a">...</span></div>

<!-- the repeat expression is invalid: the local loop variable cannot be the
     same as the looped through array  -->
<div id="e34"><p ctal:repeat="f f" ctal:content="f">...</p></div>


<!-- the entire data structure must be accessible from inside the loop -->
<div id="e35"><p ctal:repeat="item f"><span ctal:content="a"></span></p></div>


<!-- Tests follow -->
<script type="text/javascript">
// <![CDATA[

  var data = {
    a: 1,
    b: 2,
    c: {
      d: 3,
      e: 4
    },
    f: [4, 5, 6],
    g: [
      {h: 7, i: 8, j: 9}
    ],
    k: {
      l: {
        m: 10
      }
    },
    ctrue: 1,
    cfalse: 0
  }

  function htmlOf(node) {
    var text = $(node).innerHTML;
    return text.toLowerCase().replace(/\r/g, '').replace(/\n/g,'');
  }

  try {
    ctal.process_ctal(document, data);
  } catch (e) {}

  var inspect = Test.Unit.inspect;

  new Test.Unit.Runner({

    testDataStructure: function() { with(this) {
      assertEqual(1, data['a']);
      assertEqual(2, data['b']);
      assertEqual(3, data['c']['d']);
      assertEqual(4, data['c']['e']);
      assertEqual(inspect([4, 5, 6]), inspect(data['f']));
      assertEqual(inspect({h: 7, i: 8, j: 9}), inspect(data['g'][0]));
      assertEqual(10, data['k']['l']['m']);
      assertEqual(1, data['ctrue']);
      assertEqual(0, data['cfalse']);
    }},

    testPrivateAPI: function() { with(this) {
      assertEqual(inspect(['style', '']),
                  inspect(ctal.get_nameexpr('style')));
      assertEqual(inspect(['style', 'string:1']),
                  inspect(ctal.get_nameexpr('style string:1')));
      assertEqual(inspect(['style', 'string:1']),
                  inspect(ctal.get_nameexpr(' style   string:1  ')));
      assertEqual(inspect(['style', 'a/b/c']),
                  inspect(ctal.get_nameexpr(' style a/b/c')));
      assertEqual(inspect(['style', 'a/b/c; color a/b']),
                  inspect(ctal.get_nameexpr('style a/b/c; color a/b')));
    }},

    testTALContent: function() { with(this) {
      assertEqual('<span>1</span>', htmlOf("e0"));
      assertEqual('<span>3</span>', htmlOf("e1"));
      assertEqual('<span>a</span>', htmlOf("e2"));
      assertEqual('<span>10</span>', htmlOf("e3"));
      assertEqual('<span>true</span>', htmlOf("e3b"));
      assertEqual('<span>false</span>', htmlOf("e3c"));
    }},

    testTALConditionTALContent: function() { with(this) {
      assertEqual('<span>b</span>', htmlOf("e4"));
      assertEqual('<span>b</span>', htmlOf("e4b"));
      assertEqual('', htmlOf("e5"));
      assertEqual('', htmlOf("e5b"));
    }},

    testTALContentTALAttributes: function() { with(this) {
      assertEqual('<span class="e">d</span>', htmlOf("e6"));
      assertEqual('<span class="e">d</span>', htmlOf("e6b"));
    }},

    testTALConditionTALContentTALAttributes: function() { with(this) {
      assertEqual('<span class="g">f</span>', htmlOf("e7"));
      assertEqual('<span class="g">f</span>', htmlOf("e7b"));
      assertEqual('<span class="g">f</span>', htmlOf("e7c"));
      assertEqual('<span class="g">f</span>', htmlOf("e7d"));
      assertEqual('<span class="g">f</span>', htmlOf("e7e"));
      assertEqual('', htmlOf("e8"));
      assertEqual('', htmlOf("e8b"));
      assertEqual('', htmlOf("e8c"));
      assertEqual('', htmlOf("e8d"));
      assertEqual('', htmlOf("e8e"));
      assertEqual('', htmlOf("e8f"));
    }},

    testTALOmittagTALContentTALCondition: function() { with(this) {
      assertEqual('j', htmlOf("e9"));
      assertEqual('j', htmlOf("e9b"));
      assertEqual('j', htmlOf("e9c"));
      assertEqual('j', htmlOf("e9d"));
      assertEqual('j', htmlOf("e9e"));
      assertEqual('j', htmlOf("e9f"));
      assertEqual('', htmlOf("e10"));
      assertEqual('', htmlOf("e10b"));
      assertEqual('', htmlOf("e10c"));
      assertEqual('', htmlOf("e10d"));
      assertEqual('', htmlOf("e10e"));
      assertEqual('', htmlOf("e10f"));
      assertEqual('<span>l</span>', htmlOf("e11"));
      assertEqual('', htmlOf("e12"));
    }},

    testTALAttributes: function() { with(this) {
      assertEqual('<a alt="o">...</a>', htmlOf("e13"));
      assertEqual('<a alt="o" href="http://p/">...</a>', htmlOf("e14"));
    }},

    testTALAttributesTALContent: function() { with(this) {
      assert(htmlOf("e15") == '<a alt="q" href="http://r/">s</a>' ||
             htmlOf("e15") == '<a href="http://r/" alt="q">s</a>');

      assert(htmlOf("e15b") == '<a alt="q" href="http://r/">s</a>' ||
             htmlOf("e15b") == '<a href="http://r/" alt="q">s</a>');
    }},

    testTALReplace: function() { with(this) {
      assertEqual('t', htmlOf("e16"));
    }},

    testTALConditionTALReplace: function() { with(this) {
      assertEqual('u', htmlOf("e17"));
      assertEqual('u', htmlOf("e17b"));
      assertEqual('', htmlOf("e18"));
      assertEqual('', htmlOf("e18b"));
    }},

    testTALRepeat: function() { with(this) {
      assertEqual('<div><p>4</p></div><div><p>5</p></div><div><p>6</p></div>',
                  htmlOf("e19"));

      assertEqual('<div>4</div><div>5</div><div>6</div>', htmlOf("e20"));
      assertEqual('<div>4</div><div>5</div><div>6</div>', htmlOf("e20b"));
    }},

    testTALRepeatTALAttributes: function() { with(this) {
      assertEqual(
        '<div alt="4">...</div><div alt="5">...</div><div alt="6">...</div>',
        htmlOf("e21")
      );
    }},

    testTALRepeatTALContent: function() { with(this) {
      assertEqual('<div>4</div><div>5</div><div>6</div>', htmlOf("e22"));
      assertEqual('<div>4</div><div>5</div><div>6</div>', htmlOf("e22b"));
    }},

    testTALRepeatTALContentTALAttributes: function() { with(this) {
      assertEqual(
        '<div alt="4">4</div><div alt="5">5</div><div alt="6">6</div>',
        htmlOf("e23")
      );
    }},

    testTALConditionTALRepeat: function() { with(this) {
      assertEqual('<div>...</div><div>...</div><div>...</div>',
                  htmlOf("e24"));
      assertEqual('<div>...</div><div>...</div><div>...</div>',
                  htmlOf("e24b"));

      assertEqual('', htmlOf("e25"));
      assertEqual('', htmlOf("e25b"));
    }},

    testTALConditionTALRepeatTALAttributes: function() { with(this) {
      assertEqual(
        '<div alt="4">...</div><div alt="5">...</div><div alt="6">...</div>',
        htmlOf("e26")
      );

      assertEqual('', htmlOf("e27"));
    }},

    testTALConditionTALRepeatTALContent: function() { with(this) {
      assertEqual('<div>4</div><div>5</div><div>6</div>', htmlOf("e28"));

      assertEqual('', htmlOf("e29"));
    }},

    testTALAttributes: function() { with(this) {
      assertEqual('<span color="red">...</span>', htmlOf("e30"));
      assertEqual('<span color="red">...</span>', htmlOf("e30b"));
      assertEqual('<span color="red">...</span>', htmlOf("e30c"));
      assertEqual('<span class="large" color="red">...</span>',
                  htmlOf("e30d"));
      assertEqual('<span class="large" color="red">...</span>',
                  htmlOf("e30e"));
      assertEqual('<span class="large" color="red">...</span>',
                  htmlOf("e30f"));
      assertEqual('<span class="large" color=" red">...</span>',
                  htmlOf("e30g"));
    }},

    testJavascript: function() { with(this) {
      assertEqual('<span>1</span>', htmlOf("e31"));
      assertEqual('<span>2</span>', htmlOf("e31b"));
      assertEqual('<span>10</span>', htmlOf("e31c"));
    }},

    testEdgeCases: function() { with(this) {
      assertEqual('', htmlOf("e32"));
      assertEqual('<p><span>1</span></p><p><span>2</span></p>', htmlOf("e33"));

      // XXX: this one does not pass yet
      assertEqual('', htmlOf("e34"));

      assertEqual(
             '<p><span>1</span></p><p><span>1</span></p><p><span>1</span></p>',
             htmlOf("e35"));
    }}

  });

// ]]>
</script>

<div id="message"></div>
</body>
</html>
